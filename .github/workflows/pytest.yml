name: üß™ CybICS Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"  # Run daily at midnight UTC
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    name: Test Industrial Protocols
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: üîß Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y nmap
        echo "‚úì Installed nmap for S7 protocol testing"

    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
          submodules: recursive

    - name: üêç Setup Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: üê≥ Setup Docker Compose
      uses: KengoTODA/actions-setup-docker-compose@main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ‚öôÔ∏è Prepare Environment
      run: |
         chmod +x ./.devcontainer/prepare-env.sh
         .devcontainer/prepare-env.sh
         echo "‚úì Environment prepared"
      shell: bash

    - name: üöÄ Start CybICS Containers
      run: |
        echo "Starting industrial control system containers..."
        docker-compose -f "docker-compose.yml" up -d --build
        echo "‚úì Containers started"
      working-directory: ./.devcontainer/virtual

    - name: ‚è≥ Wait for Services to Initialize
      run: |
        echo "Waiting 120 seconds for all services to be ready..."
        sleep 120s
        echo "‚úì Services should be ready"
      shell: bash

    - name: üì¶ Install Python Test Dependencies
      run: |
        pip install --no-cache-dir -r tests/requirements.txt
        echo "‚úì Installed pytest, asyncua, pymodbus, and other dependencies"

    - name: üß™ Test - Basic Connectivity (HTTP, Modbus, S7)
      id: test-connectivity
      continue-on-error: true
      run: |
        echo "::group::üåê Testing Web Services, Modbus TCP, and S7 Protocol"
        pytest tests/test_connections.py \
          --verbose \
          --tb=short \
          --color=yes \
          -ra \
          --junit-xml=test-results-connectivity.xml
        echo "::endgroup::"

    - name: üîê Test - OPC UA Authentication
      id: test-opcua
      continue-on-error: true
      run: |
        echo "::group::üîë Testing OPC UA Username/Password & Certificate Authentication"
        echo "Checking OPC UA server startup logs..."
        docker logs virtual-opcua-1 2>&1 | head -n 100 || true
        echo ""
        echo "Checking certificate file inside container..."
        docker exec virtual-opcua-1 ls -la /CybICS/certificates/trusted/ || true
        docker exec virtual-opcua-1 openssl x509 -inform DER -in /CybICS/certificates/trusted/cert_admin.der -noout -subject -dates 2>&1 || true
        echo ""
        echo "Running OPC UA authentication tests..."
        pytest tests/test_opcua_auth.py \
          --verbose \
          --tb=short \
          --color=yes \
          -ra \
          -k "test_opcua" \
          --junit-xml=test-results-opcua.xml
        echo "::endgroup::"

    - name: üìö Test - Training Modules
      id: test-training
      continue-on-error: true
      run: |
        echo "::group::üìñ Testing CTF Training Module Validation"
        pytest tests/test_training.py \
          --verbose \
          --tb=short \
          --color=yes \
          -ra \
          --junit-xml=test-results-training.xml
        echo "::endgroup::"

    - name: üìä Generate Test Summary
      if: always()
      run: |
        echo "## üß™ CybICS Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Suite Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|---------|" >> $GITHUB_STEP_SUMMARY

        # Basic Connectivity
        if [ "${{ steps.test-connectivity.outcome }}" == "success" ]; then
          echo "| üåê Basic Connectivity | ‚úÖ Passed | All connection tests successful |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| üåê Basic Connectivity | ‚ùå Failed | Check logs for details |" >> $GITHUB_STEP_SUMMARY
        fi

        # OPC UA Authentication
        if [ "${{ steps.test-opcua.outcome }}" == "success" ]; then
          echo "| üîê OPC UA Authentication | ‚úÖ Passed | Username/password & certificate auth verified |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| üîê OPC UA Authentication | ‚ùå Failed | Check logs for details |" >> $GITHUB_STEP_SUMMARY
        fi

        # Training Modules
        if [ "${{ steps.test-training.outcome }}" == "success" ]; then
          echo "| üìö Training Modules | ‚úÖ Passed | All training tests successful |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| üìö Training Modules | ‚ùå Failed | Check logs for details |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Web Services (HTTP, FUXA, OpenPLC)" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Modbus TCP Protocol" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ OPC UA Protocol (with authentication)" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ S7 Protocol Detection" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Training Module Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üìä View detailed test output in the workflow logs above." >> $GITHUB_STEP_SUMMARY

    - name: üì§ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-results
        path: |
          test-results-*.xml
          pytest-*.log
        retention-days: 30
        if-no-files-found: ignore

    - name: ‚úÖ Check Test Results
      if: always()
      run: |
        echo "========================================="
        echo "   Final Test Results Check"
        echo "========================================="
        if [ "${{ steps.test-connectivity.outcome }}" != "success" ] || \
           [ "${{ steps.test-opcua.outcome }}" != "success" ] || \
           [ "${{ steps.test-training.outcome }}" != "success" ]; then
          echo ""
          echo "‚ùå Some tests failed. Check the summary above for details."
          echo ""
          echo "Test Outcomes:"
          echo "  Basic Connectivity: ${{ steps.test-connectivity.outcome }}"
          echo "  OPC UA Auth: ${{ steps.test-opcua.outcome }}"
          echo "  Training Modules: ${{ steps.test-training.outcome }}"
          echo ""
          exit 1
        else
          echo ""
          echo "‚úÖ All tests passed successfully!"
          echo ""
          echo "Test Outcomes:"
          echo "  ‚úì Basic Connectivity: ${{ steps.test-connectivity.outcome }}"
          echo "  ‚úì OPC UA Auth: ${{ steps.test-opcua.outcome }}"
          echo "  ‚úì Training Modules: ${{ steps.test-training.outcome }}"
          echo ""
        fi

    - name: üõë Stop Containers
      if: always()
      run: |
        echo "Stopping all CybICS containers..."
        docker-compose -f "docker-compose.yml" down
        echo "‚úì Containers stopped and cleaned up"
      working-directory: ./.devcontainer/virtual
