name: zephyr CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  ZEPHYR_SDK_VERSION: 0.17.4

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          git cmake ninja-build gperf ccache dfu-util device-tree-compiler wget \
          python3-dev python3-pip python3-setuptools python3-tk python3-wheel \
          xz-utils file make gcc gcc-multilib g++-multilib

    - name: Install west
      run: pip3 install west

    - name: Install Zephyr SDK (ARM toolchain only)
      run: |
        cd ~
        wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${ZEPHYR_SDK_VERSION}/zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64_minimal.tar.xz
        tar xf zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64_minimal.tar.xz
        cd zephyr-sdk-${ZEPHYR_SDK_VERSION}
        wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${ZEPHYR_SDK_VERSION}/toolchain_linux-x86_64_arm-zephyr-eabi.tar.xz
        tar xf toolchain_linux-x86_64_arm-zephyr-eabi.tar.xz
        ./setup.sh -t arm-zephyr-eabi -h -c
        echo "ZEPHYR_SDK_INSTALL_DIR=$HOME/zephyr-sdk-${ZEPHYR_SDK_VERSION}" >> $GITHUB_ENV

    - name: Initialize Zephyr workspace (using project manifest)
      run: |
        west init -l software/stm32
        cd software
        west update --narrow -o=--depth=1
        # Pre-pin packages to avoid pip backtracking on complex dependency resolution
        pip3 install --upgrade pip setuptools wheel setuptools_scm poetry-core
        pip3 install -r zephyr/scripts/requirements.txt

    - name: Build STM32 firmware
      working-directory: software
      run: |
        west build -b nucleo_g070rb stm32 -- -DCONFIG_COMPILER_WARNINGS_AS_ERRORS=y

    - name: Show build info
      run: |
        ls -la software/build/zephyr/zephyr.elf
        ls -la software/build/zephyr/zephyr.bin
        size software/build/zephyr/zephyr.elf
